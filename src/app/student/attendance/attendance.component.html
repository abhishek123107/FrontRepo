<div class="container">
  <h2 class="mb-4">Mark Attendance</h2>

  <!-- Active Sessions -->
  <div class="row mb-4" *ngIf="activeSessions.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Active Sessions</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3" *ngFor="let session of activeSessions">
              <div class="card h-100" [class.border-primary]="selectedSession?.id === session.id">
                <div class="card-body">
                  <h6 class="card-title">{{ session.title }}</h6>
                  <p class="card-text">{{ session.description }}</p>
                  <small class="text-muted">
                    Type: {{ getSessionTypeText(session.session_type) }}<br>
                    Time: {{ session.start_time | date:'short' }} - {{ session.end_time | date:'short' }}
                  </small>
                  <br>
                  <button
                    class="btn btn-sm mt-2"
                    [class.btn-primary]="selectedSession?.id === session.id"
                    [class.btn-outline-primary]="selectedSession?.id !== session.id"
                    (click)="selectSession(session)">
                    {{ selectedSession?.id === session.id ? 'Selected' : 'Select' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Attendance Options -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Attendance Options</h5>
        </div>
        <div class="card-body">

          <!-- QR Code Section -->
          <div class="mb-4">
            <h6>Scan QR Code</h6>
            <p class="text-muted">
              Mark attendance by scanning QR code
            </p>
            <div class="d-grid gap-2">
              <button
                class="btn btn-primary"
                (click)="openCameraScanner()"
                [disabled]="loading">
                <i class="fas fa-camera me-2"></i>
                ðŸ“· Scan QR Code
              </button>
              <button
                class="btn btn-outline-primary"
                (click)="openFileUpload()"
                [disabled]="loading">
                <i class="fas fa-upload me-2"></i>
                ï¿½ Upload QR Code
              </button>
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Enter QR code token"
                  [(ngModel)]="qrCodeInput"
                  name="qrCodeInput">
                <button
                  class="btn btn-outline-primary"
                  (click)="scanQRCode()"
                  [disabled]="loading">
                  Submit
                </button>
              </div>
            </div>
          </div>

          <!-- Admin Approval Section -->
          <div class="mb-4" *ngIf="selectedSession">
            <h6>Or request admin approval</h6>
            <p class="text-muted">
              Send a request to admin to mark your attendance
            </p>
            <button
              class="btn btn-secondary"
              (click)="requestAdminApproval()"
              [disabled]="loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              Request Admin Approval
            </button>
          </div>

          <!-- Status Messages -->
          <div
            *ngIf="attendanceStatus"
            class="alert mt-3"
            [class.alert-success]="attendanceStatus === 'marked'"
            [class.alert-info]="attendanceStatus === 'pending'">
            {{
              attendanceStatus === "marked"
                ? "âœ… Attendance marked successfully!"
                : "ðŸ“‹ Request sent for admin approval."
            }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- My Attendance History -->
  <div class="row mt-4" *ngIf="myAttendance.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>My Attendance History</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>Status</th>
                  <th>Check-in Time</th>
                  <th>Duration (Minutes)</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let record of myAttendance">
                  <td>{{ record.session }}</td>
                  <td>
                    <span class="badge"
                          [class.bg-success]="record.status === 'present'"
                          [class.bg-warning]="record.status === 'late'"
                          [class.bg-danger]="record.status === 'absent'"
                          [class.bg-info]="record.status === 'excused'">
                      {{ getStatusText(record.status) }}
                    </span>
                  </td>
                  <td>{{ record.check_in_time | date:'short' }}</td>
                  <td>{{ record.duration_minutes || 'N/A' }}</td>
                  <td>{{ record.created_at | date:'shortDate' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="modal fade" [class.show]="scannerOpen" [style.display]="scannerOpen ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ðŸ“· QR Code Scanner</h5>
          <button type="button" class="btn-close" (click)="closeScanner()"></button>
        </div>
        <div class="modal-body text-center">
          <div *ngIf="loading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Scanning...</span>
            </div>
            <p class="mt-2">Processing QR Code...</p>
          </div>

          <div *ngIf="!loading && !scanResult">
            <div class="mb-3">
              <i class="fas fa-qrcode fa-5x text-primary mb-3"></i>
              <h5>Upload QR Code Image</h5>
              <p class="text-muted">Select an image containing the QR code</p>
            </div>
            <div class="mb-3">
              <input
                type="file"
                class="form-control"
                accept="image/*"
                (change)="onFileSelect($event)"
                #fileInput>
            </div>
            <small class="text-muted">
              Supported formats: JPG, PNG, GIF<br>
              Maximum file size: 5MB
            </small>
          </div>

          <div *ngIf="scanResult && !attendanceResult" class="mb-3">
            <div class="alert" [class.alert-success]="scanResult.success" [class.alert-danger]="!scanResult.success">
              <h6>Scan Result</h6>
              <p><strong>Success:</strong> {{ scanResult.success }}</p>
              <p *ngIf="scanResult.qr_data"><strong>QR Data:</strong> {{ scanResult.qr_data }}</p>
              <p *ngIf="scanResult.confidence"><strong>Confidence:</strong> {{ (scanResult.confidence * 100).toFixed(1) }}%</p>
              <p *ngIf="scanResult.error"><strong>Error:</strong> {{ scanResult.error }}</p>
            </div>
          </div>

          <div *ngIf="attendanceResult" class="mb-3">
            <div class="alert" [class.alert-success]="attendanceResult.success" [class.alert-danger]="!attendanceResult.success">
              <h6>Attendance Result</h6>
              <p *ngIf="attendanceResult.message"><strong>Message:</strong> {{ attendanceResult.message }}</p>
              <p *ngIf="attendanceResult.session"><strong>Session:</strong> {{ attendanceResult.session }}</p>
              <p *ngIf="attendanceResult.check_in_time"><strong>Check-in:</strong> {{ attendanceResult.check_in_time | date:'medium' }}</p>
              <p *ngIf="attendanceResult.status"><strong>Status:</strong> {{ attendanceResult.status }}</p>
              <p *ngIf="attendanceResult.error"><strong>Error:</strong> {{ attendanceResult.error }}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeScanner()">Close</button>
          <button *ngIf="selectedFile && !scanResult" type="button" class="btn btn-primary" (click)="scanQRFromFile()" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
            Scan QR Code
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Camera Scanner Modal -->
  <div class="modal fade" [class.show]="cameraScannerOpen" *ngIf="cameraScannerOpen" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-camera me-2"></i>Scan QR Code
          </h5>
          <button type="button" class="btn-close" (click)="closeCameraScanner()"></button>
        </div>
        <div class="modal-body text-center">
          <div *ngIf="!cameraStream">
            <div class="mb-3">
              <i class="fas fa-camera fa-3x text-primary mb-3"></i>
              <h5>Camera Access Required</h5>
              <p class="text-muted">Please allow camera access to scan QR codes</p>
            </div>
            <button class="btn btn-primary" (click)="startCamera()" [disabled]="loading">
              <i class="fas fa-video me-2"></i>
              Start Camera
            </button>
          </div>
          
          <div *ngIf="cameraStream">
            <div class="mb-3">
              <video #videoElement class="camera-video" autoplay playsinline></video>
              <canvas #canvasElement class="d-none"></canvas>
            </div>
            <div class="mb-3">
              <p class="text-muted">Position QR code within the frame to scan</p>
            </div>
            <button class="btn btn-success" (click)="captureAndScan()" [disabled]="loading">
              <i class="fas fa-qrcode me-2"></i>
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
              {{ loading ? 'Scanning...' : 'Capture & Scan' }}
            </button>
            <button class="btn btn-outline-secondary ms-2" (click)="stopCamera()">
              <i class="fas fa-stop me-2"></i>
              Stop Camera
            </button>
          </div>
          
          <div *ngIf="scanResult" class="mt-3">
            <div class="alert" [class.alert-success]="scanResult.success" [class.alert-danger]="!scanResult.success">
              <h6>Scan Result</h6>
              <p *ngIf="scanResult.qr_data"><strong>QR Data:</strong> {{ scanResult.qr_data }}</p>
              <p *ngIf="scanResult.error"><strong>Error:</strong> {{ scanResult.error }}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCameraScanner()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- File Upload Scanner Modal -->
  <div class="modal fade" [class.show]="fileUploadOpen" *ngIf="fileUploadOpen" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-upload me-2"></i>Upload QR Code
          </h5>
          <button type="button" class="btn-close" (click)="closeFileUpload()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="!loading && !scanResult">
            <div class="mb-3">
              <i class="fas fa-qrcode fa-3x text-primary mb-3"></i>
              <h5>Upload QR Code Image</h5>
              <p class="text-muted">Select an image containing of QR code</p>
            </div>
            <div class="mb-3">
              <input
                type="file"
                class="form-control"
                accept="image/*"
                (change)="onFileSelect($event)"
                #fileInput>
            </div>
            <small class="text-muted">
              Supported formats: JPG, PNG, GIF<br>
              Maximum file size: 5MB
            </small>
          </div>

          <div *ngIf="scanResult && !attendanceResult" class="mb-3">
            <div class="alert" [class.alert-success]="scanResult.success" [class.alert-danger]="!scanResult.success">
              <h6>Scan Result</h6>
              <p><strong>Success:</strong> {{ scanResult.success }}</p>
              <p *ngIf="scanResult.qr_data"><strong>QR Data:</strong> {{ scanResult.qr_data }}</p>
              <p *ngIf="scanResult.confidence"><strong>Confidence:</strong> {{ (scanResult.confidence * 100).toFixed(1) }}%</p>
              <p *ngIf="scanResult.error"><strong>Error:</strong> {{ scanResult.error }}</p>
            </div>
          </div>

          <div *ngIf="attendanceResult" class="mb-3">
            <div class="alert" [class.alert-success]="attendanceResult.success" [class.alert-danger]="!attendanceResult.success">
              <h6>Attendance Result</h6>
              <p *ngIf="attendanceResult.message"><strong>Message:</strong> {{ attendanceResult.message }}</p>
              <p *ngIf="attendanceResult.session"><strong>Session:</strong> {{ attendanceResult.session }}</p>
              <p *ngIf="attendanceResult.check_in_time"><strong>Check-in:</strong> {{ attendanceResult.check_in_time | date:'medium' }}</p>
              <p *ngIf="attendanceResult.status"><strong>Status:</strong> {{ attendanceResult.status }}</p>
              <p *ngIf="attendanceResult.error"><strong>Error:</strong> {{ attendanceResult.error }}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeFileUpload()">Close</button>
          <button *ngIf="selectedFile && !scanResult" type="button" class="btn btn-primary" (click)="scanQRFromFile()" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
            Scan QR Code
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div class="modal-backdrop fade" [class.show]="scannerOpen || cameraScannerOpen || fileUploadOpen" *ngIf="scannerOpen || cameraScannerOpen || fileUploadOpen"></div>
</div>
