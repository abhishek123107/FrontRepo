<app-navbar></app-navbar>
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Welcome Section with Student Profile -->
    <div class="col-12 mb-4">
      <div class="card bg-gradient-primary text-white">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h4 class="card-title mb-2">üéì Welcome to Student Dashboard</h4>
              <p class="card-text mb-1">Manage your library activities, book seats, track attendance, and stay updated with notifications.</p>
              <div class="d-flex align-items-center gap-3 mt-3">
                <span class="badge bg-light text-dark" *ngIf="studentProfile">
                  {{ studentProfile?.first_name }} {{ studentProfile?.last_name }}
                </span>
                <span class="badge" [class]="getMembershipBadgeClass(studentProfile?.membership_type || 'basic')" *ngIf="studentProfile">
                  {{ studentProfile?.membership_type?.toUpperCase() }}
                </span>
                <span class="badge bg-success" *ngIf="studentProfile?.student_id">
                  ID: {{ studentProfile?.student_id }}
                </span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <button class="btn btn-light btn-sm" (click)="refreshDashboard()" [disabled]="dashboardLoading">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <!-- Loading State -->
  <div *ngIf="dashboardLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading dashboard...</span>
    </div>
    <p class="mt-2">Loading your dashboard...</p>
  </div>

  <!-- Dashboard Content -->
  <div class="row" *ngIf="!dashboardLoading && !loading">
    <!-- Student Management Sidebar -->
    <div class="col-12 col-md-3">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5>üìä Student Management</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <!-- User Dashboard -->
            <li class="list-group-item">
              <a
                routerLink="/student"
                routerLinkActive="active"
                class="btn btn-outline-primary w-100"
                ><i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview</a
              >
            </li>

            <!-- Seat Management -->
            <li class="list-group-item">
              <a
                [routerLink]="['book-seat']"
                routerLinkActive="active"
                class="btn btn-outline-primary w-100"
                ><i class="fas fa-chair me-2"></i>Book Seat</a
              >
            </li>

            <!-- Attendance Management -->
            <li class="list-group-item">
              <a
                [routerLink]="['attendance']"
                routerLinkActive="active"
                class="btn btn-outline-secondary w-100"
                ><i class="fas fa-calendar-check me-2"></i>Mark Attendance</a
              >
            </li>

            <!-- Payment Management -->
            <li class="list-group-item">
              <a
                [routerLink]="['payments']"
                routerLinkActive="active"
                class="btn btn-outline-success w-100"
                ><i class="fas fa-credit-card me-2"></i>Payment History</a
              >
            </li>

            <!-- Profile Management -->
            <li class="list-group-item">
              <a
                [routerLink]="['profile']"
                routerLinkActive="active"
                class="btn btn-outline-info w-100"
                ><i class="fas fa-user me-2"></i>My Profile</a
              >
            </li>
          </ul>
        </div>
      </div>

      <!-- Communication & Analysis -->
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h5>üì¢ Communication & Analysis</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <!-- Notifications from Admin -->
            <li class="list-group-item">
              <a
                [routerLink]="['notifications']"
                routerLinkActive="active"
                class="btn btn-outline-warning w-100"
                ><i class="fas fa-bell me-2"></i>Notifications</a
              >
            </li>

            <!-- Send Notifications (if allowed) -->
            <li class="list-group-item">
              <a
                routerLink="/admin/notifications"
                routerLinkActive="active"
                class="btn btn-outline-danger w-100"
                *ngIf="isAdmin()"
                ><i class="fas fa-paper-plane me-2"></i>Send Notifications</a
              >
            </li>

            <!-- Feedback Analysis -->
            <li class="list-group-item">
              <a
                routerLink="/admin/feedback"
                routerLinkActive="active"
                class="btn btn-outline-dark w-100"
                *ngIf="isAdmin()"
                ><i class="fas fa-chart-bar me-2"></i>Feedback Analysis</a
              >
            </li>
          </ul>
        </div>
      </div>

      <!-- Admin Panel Access (for admins only) -->
      <div class="card mt-3" *ngIf="isAdmin()">
        <div class="card-header bg-danger text-white">
          <h5>‚öôÔ∏è Admin Panel</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <a
                routerLink="/admin/seats"
                routerLinkActive="active"
                class="btn btn-outline-danger w-100"
                ><i class="fas fa-cogs me-2"></i>Seat Management</a
              >
            </li>

            <li class="list-group-item">
              <a
                routerLink="/admin/attendance"
                routerLinkActive="active"
                class="btn btn-outline-danger w-100"
                ><i class="fas fa-users-cog me-2"></i>Attendance Panel</a
              >
            </li>

            <li class="list-group-item">
              <a
                routerLink="/admin/payments"
                routerLinkActive="active"
                class="btn btn-outline-danger w-100"
                ><i class="fas fa-money-check-alt me-2"></i>Payment Verification</a
              >
            </li>

            <li class="list-group-item">
              <a
                routerLink="/admin/leaderboard"
                routerLinkActive="active"
                class="btn btn-outline-danger w-100"
                ><i class="fas fa-trophy me-2"></i>Leaderboard</a
              >
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-12 col-md-9">
      <router-outlet></router-outlet>

      <!-- Default Dashboard Content (when no route is selected) -->
      <div *ngIf="!hasActiveRoute()" class="dashboard-overview">
        <!-- Student Profile Card -->
        <div class="card mb-4" *ngIf="studentProfile">
          <div class="card-header bg-gradient-info text-white">
            <h5 class="mb-0">üë§ Your Profile Information</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 text-center">
                <div class="avatar-placeholder mb-3">
                  <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                    <span class="text-white fs-2">{{ studentProfile?.first_name?.[0] || 'U' }}{{ studentProfile?.last_name?.[0] || '' }}</span>
                  </div>
                  <h6 class="mt-2">{{ studentProfile?.first_name }} {{ studentProfile?.last_name }}</h6>
                  <span class="badge" [class]="getMembershipBadgeClass(studentProfile?.membership_type || 'basic')">
                    {{ studentProfile?.membership_type?.toUpperCase() }}
                  </span>
                </div>
              </div>
              <div class="col-md-9">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Email:</strong> {{ studentProfile?.email }}</p>
                    <p><strong>Phone:</strong> {{ studentProfile?.phone || 'Not provided' }}</p>
                    <p><strong>Student ID:</strong> {{ studentProfile?.student_id || 'Not assigned' }}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Department:</strong> {{ studentProfile?.department || 'Not specified' }}</p>
                    <p><strong>Year of Study:</strong> {{ studentProfile?.year_of_study || 'N/A' }}</p>
                    <p><strong>Member Since:</strong> {{ studentProfile?.date_joined | date:'mediumDate' }}</p>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar" [style.width.%]="(studentProfile?.consistency_score || 0) * 100">
                    </div>
                  </div>
                  <small class="text-muted">Consistency Score: {{ ((studentProfile?.consistency_score || 0) * 100).toFixed(1) }}%</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4" *ngIf="studentStats">
          <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white h-100">
              <div class="card-body text-center">
                <i class="bi bi-calendar-check fs-2 mb-2"></i>
                <h3>{{ studentStats?.total_bookings || 0 }}</h3>
                <p class="mb-0">Total Bookings</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100">
              <div class="card-body text-center">
                <i class="bi bi-clock-history fs-2 mb-2"></i>
                <h3>{{ studentStats?.total_attendance_days || 0 }}</h3>
                <p class="mb-0">Attendance Days</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-info text-white h-100">
              <div class="card-body text-center">
                <i class="bi bi-credit-card fs-2 mb-2"></i>
                <h3>{{ studentStats?.total_payments || 0 }}</h3>
                <p class="mb-0">Payments Made</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white h-100">
              <div class="card-body text-center">
                <i class="bi bi-hourglass-split fs-2 mb-2"></i>
                <h3>{{ studentStats?.pending_payments || 0 }}</h3>
                <p class="mb-0">Pending Approvals</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="row mb-4" *ngIf="studentStats">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>üìà Booking Statistics</h5>
              </div>
              <div class="card-body">
                <div class="row text-center">
                  <div class="col-4">
                    <h4 class="text-success">{{ studentStats?.active_bookings || 0 }}</h4>
                    <p class="text-muted small">Active</p>
                  </div>
                  <div class="col-4">
                    <h4 class="text-primary">{{ studentStats?.completed_bookings || 0 }}</h4>
                    <p class="text-muted small">Completed</p>
                  </div>
                  <div class="col-4">
                    <h4 class="text-danger">{{ studentStats?.cancelled_bookings || 0 }}</h4>
                    <p class="text-muted small">Cancelled</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>üéØ Performance Metrics</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Attendance Rate</span>
                    <span class="badge bg-success">{{ studentStats?.attendance_percentage || 0 }}%</span>
                  </div>
                  <div class="progress mt-1" style="height: 8px;">
                    <div class="progress-bar bg-success" [style.width.%]="studentStats?.attendance_percentage || 0"></div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Membership Status</span>
                    <span class="badge" [class]="getMembershipBadgeClass(studentProfile?.membership_type || 'basic')">
                      {{ studentStats?.membership_status || 'Unknown' }}
                    </span>
                  </div>
                </div>
                <div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Days Until Expiry</span>
                    <span class="badge" [class]="(studentStats?.days_until_expiry || 0) > 30 ? 'bg-success' : (studentStats?.days_until_expiry || 0) > 7 ? 'bg-warning' : 'bg-danger'">
                      {{ studentStats?.days_until_expiry || 0 }} days
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <h5>üîî Recent Activity</h5>
          </div>
          <div class="card-body">
            <div *ngIf="!recentActivities || recentActivities.length === 0" class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-1"></i>
              <p class="mt-2">No recent activity found</p>
            </div>
            <div class="list-group list-group-flush" *ngIf="recentActivities && recentActivities.length > 0">
              <div class="list-group-item" *ngFor="let activity of recentActivities">
                <div class="d-flex align-items-start">
                  <div class="me-3">
                    <i class="bi {{ getActivityIcon(activity?.type) }} fs-4 {{ getActivityColor(activity?.type) }}"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1">{{ activity?.title || 'Unknown Activity' }}</h6>
                    <p class="mb-1 text-muted">{{ activity?.description || 'No description available' }}</p>
                    <div class="d-flex align-items-center gap-2">
                      <small class="text-muted">{{ formatTimeAgo(activity?.timestamp) }}</small>
                      <span class="badge" [class]="getStatusColor(activity?.status)" *ngIf="activity?.status">
                        {{ activity?.status }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


